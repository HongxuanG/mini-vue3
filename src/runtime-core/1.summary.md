# 🚀vue3 从 template 到真实 DOM 的渲染（一）

## 前言

本文将会实现一个简单的 vue 运行时 runtime，通过 rollup 打包 runtime，并确保能在 html 中渲染出元素。

本文的函数命名全部采用 vue3 的函数名称，降低对 vue3 源码的学习成本。在巩固自己对 vue3 的理解的同时，把知识分享给大家是我的乐趣所在。

> 🤣 如有错漏，请多指教 ❤

## 简述一下大致的过程

1. template 编译成 render 函数
2. 根据编译后的结果生成 vnode
3. patch 函数对 vnode 进行`拆箱`操作
4. 通过 createElement 把 vnode 转成真实的 DOM
5. 挂载 dom 到指定的 dom 容器上

## 预览本 demo 的使用方法

万事开头，有一个最终结果往往能让我们朝着一个方向前进。

```html
<style>
  .red {
    width: 100px;
    color: red;
    background-color: aqua;
  }
  .blue {
    width: 100px;
    color: blue;
    background-color: aqua;
  }
  .flex {
    display: flex;
  }
  .container-r {
    flex-flow: row nowrap;
    justify-content: space-between;
    align-items: center;
  }
</style>
<body>
  <div id="app"></div>
  <script src="./main.js" type="module"></script>
</body>
```
```javascript
// In main.js

const rootContainer = document.querySelector('#app')

createApp(App).mount(rootContainer)
```
```javascript
// In app.js
// 这里就是template经过编译后，得到的对象，里面会包含一个render()函数
export default {
  render() {
    return h('div', {
      id: 'root',
      class: ['flex', 'container-r']
    }, [
      h('p', {class: 'red'}, 'red'),
      h('p', {class: 'blue'}, 'blue')
    ])
  },
  setup() {
    // 返回对象或者h()渲染函数
    return {
      name: 'hi my app'
    }
  }
}

```


## 编译 template 成 render 函数



## 生成虚拟节点 vnode

由于只是实现简单的渲染vnode功能，所以目前只需要返回vnode对象

```typescript
export function createVNode(type: any, props?: any, children?: any) {
  const vnode = {
    type,
    props,
    children,
  }
  return vnode
}

```

## 经过 patch 拆箱

patch会判断当前传入参数的`vnode.type`属性是什么类型。

* 如果vnode.type是`string`类型，说明这个vnode是普通元素标签，patch内部会调用processElement进行对普通元素的vnode继续处理，processElement内部又用了mountElement()把vnode.type用createElement创建出dom元素。

* 如果vnode.type是`object`类型，说明这个vnode是一个组件。再次调用vnode.type.render()可以得到子元素的vnode，用子元素的vnode再次调用patch()进行拆箱操作，直到vnode.type是普通元素标签为止。


## 生成真实 DOM 节点

生成真实的DOM节点，其实逻辑就在mountElement()里面。

mountElement()函数传入两个参数：`vnode`和`container`。

因为此时调用mountElement的vnode已经被认定为是普通的HTMLElement，那么就能用`document.createElement(vnode.type)`创建dom节点，注意：这里的vnode.type是string类型。

除此之外，我们还必须处理vnode.props属性，它是包含着这个HTML元素的所有内联属性的对象，比如`id`、`class`、`style`等等。如果class有多个类名，通过数组表示。处理props属性我们联想到了遍历props对象然后调用`setAttribute()`函数，把属性添加到dom节点上。

我们还得处理dom节点的子节点，这里我们分两种情况：
1. vnode.children是一个`string`类型，说明子节点是文本节点。
2. vnode.children是一个`array`类型，不清楚里面的子元素是文本节点还是组件，这时我们可以通过`patch()`做拆箱处理。

定义一个mountChildren()

里面的实现大致就是：通过遍历vnode.children数组，让每个子元素都执行patch()
```typescript

```


## 最后@感谢阅读

## 本阶段的完整源码
大家进去之后，他会自动帮我们安装依赖。

* 查看效果`example/index.html`，只需要在终端输入`npm start`
* 打包runtime-core的代码可以在终端输入`npm run build`


[完整源码](https://stackblitz.com/edit/node-6ic27h?file=src%2Fruntime-core%2Fcomponent.ts,src%2Fruntime-core%2FcreateApp.ts,src%2Fruntime-core%2Fh.ts,src%2Fruntime-core%2Findex.ts,src%2Fruntime-core%2Frenderer.ts,src%2Fruntime-core%2Fvnode.ts,src%2Fshare%2Findex.ts,src%2Findex.ts,package.json,example%2Fapp.js,example%2Fmain.js,example%2Findex.html,server%2Findex.js)
